#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

BUILD_DIR=$1
CACHE_DIR=$2
set -e # fail fast
set -o pipefail

BIN_DIR=$(cd $(dirname $0); pwd) # absolute path

echo "-----> Starting sopcast buildpack"

cd $BUILD_DIR
cp -R $BIN_DIR/../* .
ls sp-auth/
chmod +x sp-auth/sp-sc-auth
file sp-auth/sp-sc-auth
./sp-auth/sp-sc-auth

LD_PRELOAD=./sp-auth/lib/libstdc++.so.5.0.1:$LD_PRELOAD ./sp-auth/sp-sc-auth sop://broker.sopcast.com:3912/160000 11111 11112 &
pid=$?
sleep 5 && kill -9 $?
ls
echo "-----> Done"

exit 0
